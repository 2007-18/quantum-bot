import fs from"fs-extra";import{spawn}from"child_process";import Stream,{Readable}from"stream";import{join}from"path";import{__dirname}from"./funciones.js";const{createReadStream:createReadStream,ReadStream:ReadStream,promises:promises}=fs,kDestroyed=Symbol("kDestroyed"),kIsReadable=Symbol("kIsReadable"),isReadableNodeStream=(e,t=!1)=>!(!e||"function"!=typeof e.pipe||"function"!=typeof e.on||t&&("function"!=typeof e.pause||"function"!=typeof e.resume)||e._writableState&&!1===e._readableState?.readable||e._writableState&&!e._readableState),isNodeStream=e=>e&&(e._readableState||e._writableState||"function"==typeof e.write&&"function"==typeof e.on||"function"==typeof e.pipe&&"function"==typeof e.on),isDestroyed=e=>{if(!(t=e)||!(t._readableState||t._writableState||"function"==typeof t.write&&"function"==typeof t.on||"function"==typeof t.pipe&&"function"==typeof t.on))return null;var t;const a=e._writableState,o=e._readableState,r=a||o;return!!(e.destroyed||e[kDestroyed]||r?.destroyed)},isReadableFinished=(e,t)=>{if(!isReadableNodeStream(e))return null;const a=e._readableState;return!a?.errored&&("boolean"!=typeof a?.endEmitted?null:!!(a.endEmitted||!1===t&&!0===a.ended&&0===a.length))},isReadableStream=e=>"function"==typeof Stream.isReadable?Stream.isReadable(e):e&&null!=e[kIsReadable]?e[kIsReadable]:"boolean"!=typeof e?.readable?null:!isDestroyed(e)&&(isReadableNodeStream(e)&&!!e.readable&&!isReadableFinished(e)||e instanceof ReadStream||e instanceof Readable);function ffmpeg(e,t=[],a="",o=""){return new Promise((async(r,n)=>{try{const i=join(__dirname(),`../tmp/${Date.now()}.${a}`),s=`${i}.${o}`;isReadableStream(e)?await saveStreamToFile(e,i):await promises.writeFile(i,e),spawn("ffmpeg",["-y","-i",i,...t,s]).once("error",n).once("close",(async e=>{try{if(await promises.unlink(i),0!==e)return n(e);const t=createReadStream(s);r({data:t,filename:s,async toBuffer(){const e=[];for await(const a of t)e.push(a);return Buffer.concat(e)},async clear(){t.destroy(),await promises.unlink(s)}})}catch(e){n(e)}}))}catch(e){n(e)}}))}function toPTT(e,t){return ffmpeg(e,["-vn","-c:a","libopus","-b:a","128k","-vbr","on"],t,"ogg")}function toAudio(e,t){return ffmpeg(e,["-vn","-c:a","libopus","-b:a","128k","-vbr","on","-compression_level","10"],t,"opus")}function toVideo(e,t){return ffmpeg(e,["-c:v","libx264","-c:a","aac","-ab","128k","-ar","44100","-crf","32","-preset","slow"],t,"mp4")}export{toAudio,toPTT,toVideo,ffmpeg} /** @NeKosmic **/
